<!DOCTYPE html>
<html lang="ko">
<head>
    <title>JWT 토큰 테스트</title>
    <meta charset="UTF-8">
</head>
<body>
<h1>JWT 토큰 테스트</h1>

<h2>1. 소셜 로그인</h2>
<button onclick="loginWithKakao()">카카오 로그인</button>
<button onclick="loginWithNaver()">네이버 로그인</button>
<button onclick="loginWithGoogle()">구글 로그인</button>

<h2>2. 토큰 갱신</h2>
<button onclick="refreshToken()">토큰 갱신</button>

<h2>3. 로그아웃</h2>
<button onclick="logout()">로그아웃</button>

<h2>4. 현재 토큰 정보</h2>
<div id="tokenInfo"></div>

<script>

    window.onload = function() {
        displayTokenInfo();
    };

    function displayTokenInfo() {
        const accessToken = localStorage.getItem('accessToken');

        if (accessToken) {
            const userInfo = getUserInfoFromToken(accessToken);

            if (userInfo) {
                document.getElementById('tokenInfo').innerHTML = `
                    <p><strong>JWT Token:</strong> ${accessToken.substring(0, 50)}...</p>
                    <p><strong>User Role:</strong> ${userInfo.userRole}</p>
                    <p><strong>BIF ID:</strong> ${userInfo.bifId}</p>
                    <p><strong>Nickname:</strong> ${userInfo.nickname}</p>
                    <p><strong>Provider:</strong> ${userInfo.provider}</p>
                    <p><strong>Provider Unique ID:</strong> ${userInfo.providerUniqueId}</p>
                    <p><strong>토큰 길이:</strong> ${accessToken.length}자</p>
                `;
            } else {
                document.getElementById('tokenInfo').innerHTML = '<p>토큰 파싱 오류</p>';
            }
        } else {
            document.getElementById('tokenInfo').innerHTML = '<p>로그인이 필요합니다.</p>';
        }
    }

    function getUserInfoFromToken(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));

            return {
                providerUniqueId: payload.sub,
                userRole: payload.role,
                bifId: payload.bifId,
                nickname: payload.nickname,
                provider: payload.provider
            };
        } catch (error) {
            console.error('토큰 파싱 오류:', error);
            return null;
        }
    }

    function loginWithKakao() {
        window.location.href = '/api/oauth2/authorization/kakao';
    }

    function loginWithNaver() {
        window.location.href = '/api/oauth2/authorization/naver';
    }

    function loginWithGoogle() {
        window.location.href = '/api/oauth2/authorization/google';
    }

    function refreshToken() {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert('Access Token이 없습니다. 먼저 로그인해주세요.');
            return;
        }

        fetch('/api/auth/refresh', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.data.accessToken) {
                    localStorage.setItem('accessToken', data.data.accessToken);
                } else if (data.data.jwtToken) {
                    localStorage.setItem('accessToken', data.data.jwtToken);
                }

                if (data.data.userRole) localStorage.setItem('userRole', data.data.userRole);
                if (data.data.bifId) localStorage.setItem('bifId', data.data.bifId);
                if (data.data.nickname) localStorage.setItem('nickname', data.data.nickname);
                if (data.data.provider) localStorage.setItem('provider', data.data.provider);

                alert('토큰 갱신 성공!');
                displayTokenInfo(); // 성공 후에만 호출
            } else {
                alert('토큰 갱신 실패: ' + data.message);
            }
        })
        .catch(error => {
            console.error('토큰 갱신 오류:', error);
            alert('토큰 갱신 중 오류가 발생했습니다.');
        });
    }

    function logout() {
        fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                localStorage.clear();
                alert('로그아웃 성공!');
                displayTokenInfo();
            } else {
                alert('로그아웃 실패: ' + data.message);
            }
        })
        .catch(error => {
            console.error('로그아웃 오류:', error);
            alert('로그아웃 중 오류가 발생했습니다.');
        });
    }


</script>
</body>
</html>
